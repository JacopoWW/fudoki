<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日本文本分析工坊</title>
  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <!-- 顶部导航 -->
  <header class="header">
    <div class="header-content">
      <a href="#" class="logo">日本文本分析工坊</a>
      <nav class="nav-menu">
        <a href="#" class="nav-item">文本分析</a>
        <a href="#" class="nav-item">语音朗读</a>
        <a href="#" class="nav-item">帮助</a>
      </nav>
    </div>
  </header>

  <!-- 主要内容区域 -->
  <div class="main-container">
    <!-- 左侧边栏 - 文档管理 -->
    <aside class="sidebar-left">
      <div class="sidebar-title">文档管理</div>
      <ul class="doc-list" id="documentList">
        <!-- 文档列表将通过JavaScript动态生成 -->
      </ul>
      <button class="new-doc-btn" id="newDocBtn">+ 新建文档</button>
      
      <div class="sidebar-title" style="margin-top: 20px;">NHK新闻</div>
      <div class="nhk-controls">
        <div style="margin-bottom: 8px;">
          <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">API端口:</label>
          <input type="number" id="apiPortInput" placeholder="8888" style="width: 100%; padding: 4px; border: 1px solid #ddd; font-size: 12px; border-radius: 2px;">
        </div>
        <button class="btn" id="loadNHKBtn" style="width: 100%; margin-bottom: 8px;">获取NHK新闻</button>
        <select id="nhkCategorySelect" style="width: 100%; margin-bottom: 8px;">
          <option value="">选择分类...</option>
          <option value="main">主要ニュース</option>
          <option value="society">社会</option>
          <option value="culture">文化・エンタメ</option>
          <option value="science">科学・医療</option>
          <option value="politics">政治</option>
          <option value="economy">経済</option>
          <option value="international">国際</option>
          <option value="sports">スポーツ</option>
        </select>
        <div id="nhkNewsList" class="nhk-news-list">
          <!-- NHK新闻列表将在这里显示 -->
        </div>
      </div>
    </aside>

    <!-- 主内容区域 -->
    <main class="content-main">
      <!-- 输入区域 -->
      <section class="input-section">
        <div class="input-group">
          <textarea id="textInput" placeholder="在此输入日语文本进行分析..."></textarea>
          <button class="btn btn-primary" id="analyzeBtn">分析文本</button>
        </div>
      </section>

      <!-- 结果显示区域 -->
      <section class="content-area" id="content">
        <div class="empty-state">
          <p>请在上方输入日语文本，点击"分析文本"开始处理</p>
        </div>
      </section>
    </main>

    <!-- 右侧边栏 - 语音控制 -->
    <aside class="sidebar-right">
      <div class="sidebar-title">语音设置</div>
      
      <div class="voice-controls">
        <div class="control-group">
          <label class="control-label">语音选择</label>
          <select id="voiceSelect">
            <option value="">选择语音...</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label">语速调节</label>
          <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1">
          <div class="speed-display" id="speedValue">1.0x</div>
        </div>

        <button class="play-all-btn" id="playAllBtn">播放全文</button>
      </div>

      <div class="sidebar-title" style="margin-top: 20px;">显示设置</div>
      
      <div class="display-controls">
        <div class="control-group">
          <label class="control-label">
            <input type="checkbox" id="showKana" checked>
            显示假名
          </label>
        </div>
        
        <div class="control-group">
          <label class="control-label">
            <input type="checkbox" id="showRomaji" checked>
            显示罗马音
          </label>
        </div>
        
        
        <div class="control-group">
          <label class="control-label">
            <input type="checkbox" id="showPos" checked>
            显示词性
          </label>
        </div>
      </div>
    </aside>
  </div>

  <!-- JavaScript文件 -->
  <script src="static/libs/kuromoji.js"></script>
  <script src="static/libs/kuroshiro.min.js"></script>
  <script src="static/libs/kuroshiro-analyzer-kuromoji.min.js"></script>
  <script src="static/libs/dict/dictionary-service.js"></script>
  <script src="static/segmenter.js"></script>
  <script src="static/main-js.js"></script>
  
  <!-- NHK新闻功能 -->
  <script>
    // NHK新闻功能
    class NHKNewsManager {
      constructor() {
        this.apiPort = 8888; // 默认端口
        this.loadNHKBtn = document.getElementById('loadNHKBtn');
        this.nhkCategorySelect = document.getElementById('nhkCategorySelect');
        this.nhkNewsList = document.getElementById('nhkNewsList');
        this.textInput = document.getElementById('textInput');
        this.apiPortInput = document.getElementById('apiPortInput');
        
        this.init();
      }
      
      getApiBase() {
        return `http://127.0.0.1:${this.apiPort}/api/nhk`;
      }
      
      init() {
        this.loadNHKBtn.addEventListener('click', () => this.loadNHKNews());
        this.nhkCategorySelect.addEventListener('change', () => this.loadNHKNewsByCategory());
        this.apiPortInput.addEventListener('change', () => this.updateApiPort());
        this.apiPortInput.addEventListener('input', () => this.updateApiPort());
        
        // 从URL参数获取端口
        this.loadPortFromUrl();
      }
      
      loadPortFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const port = urlParams.get('port');
        if (port) {
          this.apiPort = parseInt(port);
          this.apiPortInput.value = port;
        }
      }
      
      updateApiPort() {
        const port = parseInt(this.apiPortInput.value);
        if (port && port > 0 && port < 65536) {
          this.apiPort = port;
        }
      }
      
      async loadNHKNews() {
        this.showLoading();
        
        try {
          const response = await fetch(`${this.getApiBase()}/articles`);
          const data = await response.json();
          
          if (data.success) {
            this.displayNews(data.data);
          } else {
            this.showError('获取新闻失败: ' + data.error);
          }
        } catch (error) {
          this.showError('网络错误: ' + error.message);
        }
      }
      
      async loadNHKNewsByCategory() {
        const category = this.nhkCategorySelect.value;
        if (!category) return;
        
        this.showLoading();
        
        try {
          const response = await fetch(`${this.getApiBase()}/articles/${category}`);
          const data = await response.json();
          
          if (data.success) {
            this.displayNews({ [data.category]: data.data });
          } else {
            this.showError('获取新闻失败: ' + data.error);
          }
        } catch (error) {
          this.showError('网络错误: ' + error.message);
        }
      }
      
      displayNews(newsData) {
        let html = '';
        
        for (const [category, articles] of Object.entries(newsData)) {
          if (articles && articles.length > 0) {
            html += `<div class="nhk-category-section">
              <div class="nhk-category-title">${category}</div>`;
            
            articles.slice(0, 5).forEach(article => {
              html += `
                <div class="nhk-news-item" onclick="nhkNewsManager.selectNews('${article.title}', '${article.link}')">
                  <div class="nhk-news-title">${article.title}</div>
                  <div class="nhk-news-meta">
                    <span class="nhk-news-category">${category}</span>
                    <span class="nhk-news-date">${this.formatDate(article.pub_date)}</span>
                  </div>
                </div>`;
            });
            
            html += '</div>';
          }
        }
        
        this.nhkNewsList.innerHTML = html || '<div class="nhk-error">未找到新闻</div>';
      }
      
      selectNews(title, link) {
        // 将新闻标题添加到文本输入框
        const currentText = this.textInput.value;
        const newText = currentText ? `${currentText}\n\n${title}` : title;
        this.textInput.value = newText;
        
        // 自动触发分析
        if (window.analyzeText) {
          window.analyzeText();
        }
      }
      
      showLoading() {
        this.nhkNewsList.innerHTML = '<div class="nhk-loading">正在加载NHK新闻...</div>';
      }
      
      showError(message) {
        this.nhkNewsList.innerHTML = `<div class="nhk-error">${message}</div>`;
      }
      
      formatDate(dateString) {
        if (!dateString) return '';
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('ja-JP', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return dateString;
        }
      }
    }
    
    // 初始化NHK新闻管理器
    let nhkNewsManager;
    document.addEventListener('DOMContentLoaded', () => {
      nhkNewsManager = new NHKNewsManager();
    });
  </script>
</body>
</html>